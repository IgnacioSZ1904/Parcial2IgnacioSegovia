<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReViews - Examen</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* Layout Flexbox para pantalla completa */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        header { background: #00AA6C; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1000; }
        .user-panel { font-size: 0.9em; text-align: right; }
        .logout-link { color: #dfffe0; text-decoration: none; font-weight: bold; }

        /* Contenedor Principal dividido en 2 */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* Panel Izquierdo (Scrollable) */
        .sidebar { width: 400px; min-width: 350px; background: #f2f2f2; overflow-y: auto; padding: 20px; border-right: 1px solid #ddd; box-shadow: 2px 0 5px rgba(0,0,0,0.05); z-index: 900; }
        
        /* Panel Derecho (Mapa) */
        .map-container { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }

        /* Tarjetas y Formularios */
        .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .review-item { cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; }
        .review-item:hover { transform: translateX(5px); border-left-color: #00AA6C; }
        
        h2, h3 { margin-top: 0; color: #333; }
        input, button, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #00AA6C; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:hover { background: #008855; }
        button.secondary { background: #546e7a; }

        .rating-badge { background: #00AA6C; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em; float: right; }

        /* Modal Detalles */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 600px; max-width: 90%; max-height: 85vh; overflow-y: auto; border-radius: 8px; padding: 25px; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 15px; background: none; color: #333; font-size: 1.5em; width: auto; border: none; padding: 0; cursor: pointer; }
        
        .token-data { background: #2d2d2d; color: #00ff00; padding: 10px; font-family: monospace; font-size: 0.85em; overflow-x: auto; border-radius: 4px; margin-top: 5px; }
        .image-gallery { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .image-gallery img { height: 100px; border-radius: 4px; object-fit: cover; cursor: pointer; }
        .image-gallery img:hover { opacity: 0.8; }
    </style>
</head>
<body>

    <header>
        <div style="font-size: 1.5em; font-weight: bold;">ReViews ü¶â</div>
        <div class="user-panel">
            Hola, {{ user.name }} ({{ user.email }})<br>
            <a href="/auth/logout" class="logout-link">Cerrar Sesi√≥n</a>
        </div>
    </header>

    <div id="detailsModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <button class="close-btn" onclick="document.getElementById('detailsModal').style.display='none'">&times;</button>
            
            <h2 id="mTitle">Nombre Establecimiento</h2>
            <p id="mAddress" style="color:#666;"></p>
            <div style="margin-bottom: 20px;">
                Valoraci√≥n: <span id="mRating" style="font-weight:bold; color:#00AA6C; font-size:1.2em;"></span> / 5
            </div>

            <h3 style="border-bottom: 1px solid #eee; padding-bottom: 5px;">üì∏ Fotos</h3>
            <div id="mImages" class="image-gallery"></div>

            <h3 style="border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 20px;">üîí Datos de Autor√≠a y Token</h3>
            <p><strong>Autor:</strong> <span id="mAuthorName"></span> (<span id="mAuthorEmail"></span>)</p>
            <p><strong>Token Emitido (IAT):</strong> <span id="mTokenIat"></span></p>
            <p><strong>Token Caducidad (EXP):</strong> <span id="mTokenExp"></span></p>
            <div class="token-data" id="mTokenRaw"></div>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            
            <div class="card">
                <h3>üìç Buscar Direcci√≥n</h3>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="searchAddr" placeholder="Ej: Calle Larios, M√°laga" style="margin-bottom:0;">
                    <button class="secondary" onclick="searchAndCenter()" style="width: auto; margin-bottom:0;">Ir</button>
                </div>
            </div>

            <div class="card">
                <h3>üìù Nueva Rese√±a</h3>
                <form action="/reviews/add" method="post" enctype="multipart/form-data">
                    <input type="text" name="name" placeholder="Nombre Establecimiento" required>
                    <input type="text" name="address" placeholder="Direcci√≥n Postal" required>
                    
                    <label>Valoraci√≥n:</label>
                    <input type="number" name="rating" min="0" max="5" value="5" required>
                    
                    <label>Im√°genes (Multiselect):</label>
                    <input type="file" name="images" multiple accept="image/*">
                    
                    <button type="submit">Publicar Opini√≥n</button>
                </form>
            </div>

            <h3>√öltimas Rese√±as</h3>
            {% for r in reviews %}
            <div class="card review-item" onclick='openModal({{ r | tojson | safe }})'>
                <span class="rating-badge">{{ r.rating }}</span>
                <div style="font-weight:bold; font-size:1.1em;">{{ r.establishment_name }}</div>
                <div style="color:#666; font-size:0.9em;">{{ r.address }}</div>
            </div>
            {% endfor %}
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // 1. Inicializar Mapa
        var map = L.map('map').setView([36.721, -4.421], 13); // M√°laga centro
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 2. Cargar datos del backend
        var reviewsData = JSON.parse('{{ reviews | tojson | safe }}');

        // 3. Pintar marcadores
        reviewsData.forEach(r => {
            if(r.lat && r.lon){
                var marker = L.marker([r.lat, r.lon]).addTo(map);
                
                // Popup simple
                marker.bindPopup(`<b>${r.establishment_name}</b><br>‚≠ê ${r.rating}/5<br><button onclick='openModalById(${JSON.stringify(r)})' style='margin-top:5px; padding:3px;'>Ver Detalles</button>`);
                
                // Click en marcador abre modal tambi√©n
                marker.on('click', () => {
                    // Opcional: Centrar mapa al clicar
                    // map.setView([r.lat, r.lon], 15);
                });
            }
        });

        // --- FUNCIONES INTERACTIVIDAD ---

        // Buscar y Centrar (AJAX)
        async function searchAndCenter() {
            let addr = document.getElementById('searchAddr').value;
            if(!addr) return;

            let btn = document.querySelector('button.secondary');
            let originalText = btn.innerText;
            btn.innerText = "...";

            try {
                let res = await fetch(`/api/search?address=${encodeURIComponent(addr)}`);
                let data = await res.json();
                
                if(data.success) {
                    map.setView([data.lat, data.lon], 16);
                } else {
                    alert("Direcci√≥n no encontrada");
                }
            } catch(e) {
                alert("Error de conexi√≥n");
            }
            btn.innerText = originalText;
        }

        // Abrir Modal
        function openModal(data) {
            // Rellenar datos b√°sicos
            document.getElementById('mTitle').innerText = data.establishment_name;
            document.getElementById('mAddress').innerText = data.address;
            document.getElementById('mRating').innerText = data.rating;

            // Im√°genes
            let gallery = document.getElementById('mImages');
            gallery.innerHTML = '';
            if(data.images && data.images.length > 0) {
                data.images.forEach(url => {
                    let img = document.createElement('img');
                    img.src = url;
                    img.onclick = function() { window.open(url, '_blank'); }; // Ver grande
                    gallery.appendChild(img);
                });
            } else {
                gallery.innerHTML = '<span style="color:#999">Sin im√°genes</span>';
            }

            // Datos Autor y Token
            if(data.author) {
                document.getElementById('mAuthorName').innerText = data.author.name || 'Desconocido';
                document.getElementById('mAuthorEmail').innerText = data.author.email || '';
                document.getElementById('mTokenRaw').innerText = data.author.token || '...';
                
                // Formatear fechas timestamp
                let iat = data.author.token_iat ? new Date(data.author.token_iat * 1000).toLocaleString() : '-';
                let exp = data.author.token_exp ? new Date(data.author.token_exp * 1000).toLocaleString() : '-';
                
                document.getElementById('mTokenIat').innerText = iat;
                document.getElementById('mTokenExp').innerText = exp;
            }

            document.getElementById('detailsModal').style.display = 'flex';
        }

        // Wrapper para el popup del mapa (porque onclick recibe string)
        function openModalById(data) {
            openModal(data);
        }

        // Cerrar al clicar fuera
        function closeModal(e) {
            if(e.target.id === 'detailsModal') {
                document.getElementById('detailsModal').style.display = 'none';
            }
        }
    </script>
</body>
</html>